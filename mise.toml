# SPDX-FileCopyrightText: 2017-2026 City of Espoo
#
# SPDX-License-Identifier: LGPL-2.1-or-later

[tools]
node = "24.13.0"

[tasks.start]
description = "Start the development environment"
dir = "compose"
run = """
#!/usr/bin/env bash
set -euo pipefail

docker compose up -d
pm2 start

FRONTEND_PORT=${EVAKA_FRONTEND_PORT:-9099}

echo "Development environment started."
echo "Open http://localhost:${FRONTEND_PORT}/ in your browser."
"""

[tasks.restart]
description = "Restart services in the development environment"
usage = """
arg "[services]" var=#true help="Service(s) to restart" {
    choices "all" "frontend" "apigw" "service"
}
"""
dir = "compose"
run = """
pm2 restart {{ usage.services | default(value=["all"]) | join(sep=" ") }}
"""

[tasks.stop]
description = "Stop the development environment"
dir = "compose"
run = """
#!/usr/bin/env bash
set -euo pipefail

pm2 kill
docker compose down

echo "Development environment stopped."
"""

[tasks.use]
description = "Activate eVaka instance with offset ports"
run = """
#!/usr/bin/env bash
set -euo pipefail

INSTANCE=${1:-}

if [ -z "$INSTANCE" ]; then
  echo "Deactivating eVaka instance (returning to default)..."
  rm -f mise.local.toml
  exit 0
fi

cat > mise.local.toml <<EOF
# Auto-generated by: mise run use $INSTANCE
# To deactivate: mise run deactivate

[env]
EVAKA_INSTANCE = "$INSTANCE"
EVAKA_DB_PORT = "$((5432 + INSTANCE))"
EVAKA_REDIS_PORT = "$((6379 + INSTANCE))"
EVAKA_S3_PORT = "$((9876 + INSTANCE))"
EVAKA_SFTP_PORT = "$((2222 + INSTANCE))"
EVAKA_IDP_PORT = "$((9090 + INSTANCE))"
EVAKA_APIGW_PORT = "$((3000 + INSTANCE))"
SERVER_PORT = "$((8888 + INSTANCE))"
EVAKA_FRONTEND_PORT = "$((9099 + INSTANCE))"
EVAKA_DATABASE_PORT = "$((5432 + INSTANCE))"
COMPOSE_PROJECT_NAME = "evaka-$INSTANCE"
PM2_HOME = "{{ env.HOME }}/.pm2-evaka-$INSTANCE"
EOF

echo "Activated eVaka instance $INSTANCE."
echo ""
echo "- Run 'mise run start' to start the development environment"
echo "- Alternatively, run 'docker-compose' and 'pm2' manually in compose/ directory."
echo "- Run 'mise run deactivate' to return to default."

MARKER="# evaka-prompt-start"
SHELL_NAME=$(basename "$SHELL")
case "$SHELL_NAME" in
  bash) RC_FILE="$HOME/.bashrc" ;;
  zsh)  RC_FILE="$HOME/.zshrc" ;;
  *)    RC_FILE="" ;;
esac

if [ -n "$RC_FILE" ] && [ -f "$RC_FILE" ] && ! grep -q "$MARKER" "$RC_FILE"; then
  echo ""
  echo "Tip: Run 'mise run install-prompt' to show the active instance in your shell prompt."
fi
"""

[tasks.deactivate]
description = "Deactivate eVaka instance (return to default)"
depends = ["use"]

[tasks.status]
description = "Show current eVaka instance configuration"
run = """
#!/usr/bin/env bash
if [ -f mise.local.toml ]; then
  echo "Active configuration (from mise.local.toml):"
  echo ""
fi

echo "Current environment:"
mise env | grep EVAKA_ | sort
"""

[tasks.instances]
description = "List running eVaka instances"
run = """{% raw %}
#!/usr/bin/env bash
set -euo pipefail

found=false

while IFS= read -r project; do
  case "$project" in
    compose)  instance="(default)" ;;
    evaka-*)  instance="${project#evaka-}" ;;
    *)        continue ;;
  esac

  services=$(docker ps --filter "label=com.docker.compose.project=$project" \
    --format '{{.Label "com.docker.compose.service"}}' | sort | paste -sd, -)

  printf "%-20s  Services: %s\n" "Instance $instance" "$services"
  found=true
done < <(docker ps --filter "label=com.docker.compose.service=db" \
  --format '{{.Label "com.docker.compose.project"}}' 2>/dev/null | sort -u)

if [ "$found" = false ]; then
  echo "No running eVaka instances found."
fi
{% endraw %}"""

[tasks.install-prompt]
description = "Install shell prompt indicator for active eVaka instance"
run = """
#!/usr/bin/env bash
set -euo pipefail

MARKER_START="# evaka-prompt-start"
MARKER_END="# evaka-prompt-end"

SHELL_NAME=$(basename "$SHELL")
case "$SHELL_NAME" in
  bash) RC_FILE="$HOME/.bashrc" ;;
  zsh)  RC_FILE="$HOME/.zshrc" ;;
  *)
    echo "Unsupported shell: $SHELL_NAME (only bash and zsh are supported)"
    exit 1
    ;;
esac

if grep -q "$MARKER_START" "$RC_FILE" 2>/dev/null; then
  echo "Prompt support is already installed in $RC_FILE"
  exit 0
fi

BASH_SNIPPET='
_evaka_prompt_cmd() {
  local clean="${PS1#\\[evaka:*\\] }"
  if [ -n "$EVAKA_INSTANCE" ]; then
    PS1="[evaka:$EVAKA_INSTANCE] $clean"
  else
    PS1="$clean"
  fi
}
PROMPT_COMMAND="_evaka_prompt_cmd${PROMPT_COMMAND:+;$PROMPT_COMMAND}"
'

ZSH_SNIPPET='
_evaka_update_prompt() {
  local clean="${PROMPT#\\[evaka:*\\] }"
  if [[ -n "$EVAKA_INSTANCE" ]]; then
    PROMPT="[evaka:$EVAKA_INSTANCE] $clean"
  else
    PROMPT="$clean"
  fi
}
precmd_functions+=(_evaka_update_prompt)
'

case "$SHELL_NAME" in
  bash) SNIPPET="$BASH_SNIPPET" ;;
  zsh)  SNIPPET="$ZSH_SNIPPET" ;;
esac

printf '\\n%s\\n%s\\n%s\\n' "$MARKER_START" "$SNIPPET" "$MARKER_END" >> "$RC_FILE"

echo "Installed eVaka prompt support in $RC_FILE"
echo "Restart your shell or run: source $RC_FILE"
"""

[tasks.uninstall-prompt]
description = "Remove shell prompt indicator for active eVaka instance"
run = """
#!/usr/bin/env bash
set -euo pipefail

MARKER_START="# evaka-prompt-start"
MARKER_END="# evaka-prompt-end"

SHELL_NAME=$(basename "$SHELL")
case "$SHELL_NAME" in
  bash) RC_FILE="$HOME/.bashrc" ;;
  zsh)  RC_FILE="$HOME/.zshrc" ;;
  *)
    echo "Unsupported shell: $SHELL_NAME (only bash and zsh are supported)"
    exit 1
    ;;
esac

if ! grep -q "$MARKER_START" "$RC_FILE" 2>/dev/null; then
  echo "Prompt support is not installed in $RC_FILE"
  exit 0
fi

sed -i.bak "/$MARKER_START/,/$MARKER_END/d" "$RC_FILE"
rm -f "$RC_FILE.bak"

echo "Removed eVaka prompt support from $RC_FILE"
echo "Restart your shell or run: source $RC_FILE"
"""

[tasks.reset-local-db]
description = "Drop and recreate the evaka_local development database"
dir = "compose"
run = "docker compose exec -T db reset-local-db"

[tasks.reset-test-db]
description = "Drop and recreate the evaka_it integration test database"
dir = "compose"
run = "docker compose exec -T db reset-it-db"

[tasks.dump-schema]
description = "Dump the database schema to docs/db/schema.sql"
run = "bin/dump-db-schema.sh > docs/db/schema.sql"
