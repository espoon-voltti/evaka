# SPDX-FileCopyrightText: 2017-2026 City of Espoo
#
# SPDX-License-Identifier: LGPL-2.1-or-later

[tools]
node = "24.13.0"

[tasks.start]
description = "Start the development environment"
dir = "compose"
run = """
#!/usr/bin/env bash
set -euo pipefail

docker compose up -d
pm2 start

FRONTEND_PORT=${EVAKA_FRONTEND_PORT:-9099}

echo "Development environment started."
echo "Open http://localhost:${FRONTEND_PORT}/ in your browser."
"""

[tasks.restart]
description = "Restart services in the development environment"
usage = """
arg "[services]" var=#true help="Service(s) to restart" {
    choices "all" "frontend" "apigw" "service"
}
"""
dir = "compose"
run = """
pm2 restart {{ usage.services | default(value=["all"]) | join(sep=" ") }}
"""

[tasks.stop]
description = "Stop the development environment"
dir = "compose"
run = """
#!/usr/bin/env bash
set -euo pipefail

pm2 kill
docker compose down

echo "Development environment stopped."
"""

[tasks.use]
description = "Activate eVaka instance with offset ports"
run = """
#!/usr/bin/env bash
set -euo pipefail

INSTANCE=${1:-}

if [ -z "$INSTANCE" ]; then
  echo "Deactivating eVaka instance (returning to default)..."
  rm -f mise.local.toml
  exit 0
fi

cat > mise.local.toml <<EOF
# Auto-generated by: mise run use $INSTANCE
# To deactivate: mise run deactivate

[env]
EVAKA_INSTANCE = "$INSTANCE"
EVAKA_DB_PORT = "$((5432 + INSTANCE))"
EVAKA_REDIS_PORT = "$((6379 + INSTANCE))"
EVAKA_S3_PORT = "$((9876 + INSTANCE))"
EVAKA_SFTP_PORT = "$((2222 + INSTANCE))"
EVAKA_IDP_PORT = "$((9090 + INSTANCE))"
EVAKA_APIGW_PORT = "$((3000 + INSTANCE))"
SERVER_PORT = "$((8888 + INSTANCE))"
EVAKA_FRONTEND_PORT = "$((9099 + INSTANCE))"
EVAKA_DATABASE_PORT = "$((5432 + INSTANCE))"
COMPOSE_PROJECT_NAME = "evaka-$INSTANCE"
PM2_HOME = "{{ env.HOME }}/.pm2-evaka-$INSTANCE"
EOF

echo "Activated eVaka instance $INSTANCE."
echo ""
echo "- Run 'mise run start' to start the development environment"
echo "- Alternatively, run 'docker-compose' and 'pm2' manually in compose/ directory."
echo "- Run 'mise run deactivate' to return to default."
"""

[tasks.deactivate]
description = "Deactivate eVaka instance (return to default)"
depends = ["use"]

[tasks.status]
description = "Show current eVaka instance configuration"
run = """
#!/usr/bin/env bash
if [ -f mise.local.toml ]; then
  echo "Active configuration (from mise.local.toml):"
  echo ""
fi

echo "Current environment:"
mise env | grep EVAKA_ | sort
"""

[tasks.reset-local-db]
description = "Drop and recreate the evaka_local development database"
dir = "compose"
run = "docker compose exec -T db reset-local-db"

[tasks.reset-test-db]
description = "Drop and recreate the evaka_it integration test database"
dir = "compose"
run = "docker compose exec -T db reset-it-db"
